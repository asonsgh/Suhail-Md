let { smd, axios, Config } = require("../lib");

smd({
  pattern: 'short ?(.*)',
  fromMe: true,
  desc: 'Generate a short video based on the topic',
  type: 'fun'
}, async (message, match) => {
  const topic = match[1];
  if (!topic) {
    return await message.send('*Please provide a topic!*\n*Example: short Artificial Intelligence*');
  }

  try {
    // Step 3: Generate Video Script
    const scriptResponse = await axios.post(`${Config.API_URL}/api/v1/scripts`, {
      video_subject: topic,
      video_language: "en",
      paragraph_number: 3
    });

    const videoScript = scriptResponse.data.data.video_script;

    // Step 4: Generate Video Terms
    const termsResponse = await axios.post(`${Config.API_URL}/api/v1/terms`, {
      video_subject: topic,
      video_script: videoScript,
      amount: 5
    });

    const videoTerms = termsResponse.data.data.video_terms;

    // Step 5: Create Short Video
    const videoResponse = await axios.post(`${Config.API_URL}/api/v1/videos`, {
      video_subject: topic,
      video_script: videoScript,
      video_terms: videoTerms,
      video_aspect: "portrait",
      video_concat_mode: "random",
      max_clip_duration: 5,
      source: "local",
      materials: [],
      video_language: "en",
      voice: "default",
      bgm_type: "random",
      subtitle_enabled: true,
      font_name: "Arial",
      font_size: 24,
      text_fore_color: "#FFFFFF",
      text_background_color: "transparent",
      stroke_color: "#000000",
      stroke_width: 1.5
    });

    const taskId = videoResponse.data.data.task_id;

    // Step 6: Query Task Status
    let taskStatus;
    let taskStatusResponse;
    do {
      await new Promise(resolve => setTimeout(resolve, 5000)); // Wait for 5 seconds
      taskStatusResponse = await axios.get(`${Config.API_URL}/api/v1/tasks/${taskId}`);
      taskStatus = taskStatusResponse.data.data.status;
    } while (taskStatus !== "completed");

    // Step 7: Send the Video
    const videoUrl = taskStatusResponse.data.data.videos[0];
    await message.send(`Here is your video on *${topic}*:\n${videoUrl}`);
  } catch (error) {
    await message.send(`Error: ${error.message}`);
  }
});
